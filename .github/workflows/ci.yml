name: MentorMatch CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'

jobs:
  # Job 1: Code Quality Checks
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: BackEnd/package-lock.json

      - name: Install backend dependencies
        working-directory: ./BackEnd
        run: npm ci

      - name: Run ESLint on backend
        working-directory: ./BackEnd
        run: |
          npx eslint src/**/*.js --format stylish || echo "::warning::ESLint found issues but continuing..."
        continue-on-error: true

      - name: Check for security vulnerabilities
        working-directory: ./BackEnd
        run: |
          npm audit --audit-level=moderate || echo "::warning::Security vulnerabilities found"
        continue-on-error: true

      - name: Validate required files exist
        run: |
          echo "Checking required files..."
          files=(
            "Dockerfile"
            ".dockerignore"
            ".env.example"
            "BackEnd/src/app.js"
            "BackEnd/src/bootstrap.js"
            "BackEnd/package.json"
            "DataBase/Mentormatch.sql"
            "FrontEnd/Pages/Home.html"
          )
          
          missing_files=()
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
              echo "::error::Missing required file: $file"
            else
              echo "✓ Found: $file"
            fi
          done
          
          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "::error::Missing ${#missing_files[@]} required file(s)"
            exit 1
          fi
          
          echo "All required files present!"

      - name: Check for console.log in production code
        run: |
          echo "Scanning for console.log statements..."
          if grep -r "console\.log" BackEnd/src --include="*.js" | grep -v "//.*console\.log"; then
            echo "::warning::Found console.log statements in production code"
          else
            echo "No problematic console.log statements found"
          fi
        continue-on-error: true

      - name: Validate package.json scripts
        working-directory: ./BackEnd
        run: |
          echo "Validating package.json scripts..."
          if ! grep -q '"start"' package.json; then
            echo "::error::Missing 'start' script in package.json"
            exit 1
          fi
          if ! grep -q '"test"' package.json; then
            echo "::warning::Missing 'test' script in package.json"
          fi
          echo "package.json scripts validated!"

  # Job 2: Docker Build Verification
  docker-build:
    name: Docker Build & Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: mentormatch:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Get Docker image size
        run: |
          SIZE=$(docker images mentormatch:ci-${{ github.sha }} --format "{{.Size}}")
          echo "Docker image size: $SIZE"
          echo "### Docker Build Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** mentormatch:ci-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Size:** $SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status:** ✅ Success" >> $GITHUB_STEP_SUMMARY

      - name: Run Trivy security scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: mentormatch:ci-${{ github.sha }}
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Test Docker container health
        run: |
          echo "Starting container for health check..."
          docker run -d --name mentormatch-test \
            -e DB_HOST=localhost \
            -e DB_PORT=5432 \
            -e DB_NAME=test \
            -e DB_USER=test \
            -e DB_PASSWORD=test \
            -e JWT_SECRET=test_secret_key_for_ci \
            -e PORT=5000 \
            -e NODE_ENV=test \
            mentormatch:ci-${{ github.sha }}
          
          echo "Waiting for container to be healthy..."
          sleep 10
          
          if docker ps | grep mentormatch-test | grep -q "Up"; then
            echo "✅ Container is running"
          else
            echo "::error::Container failed to start"
            docker logs mentormatch-test
            exit 1
          fi
          
          docker stop mentormatch-test
          docker rm mentormatch-test

  # Job 3: Configuration Validation
  config-validation:
    name: Configuration Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate .env.example completeness
        run: |
          echo "Validating .env.example..."
          required_vars=(
            "DB_HOST"
            "DB_PORT"
            "DB_NAME"
            "DB_USER"
            "DB_PASSWORD"
            "JWT_SECRET"
            "SENDGRID_API_KEY"
            "FROM_EMAIL"
            "GOOGLE_CLIENT_ID"
            "GOOGLE_CLIENT_SECRET"
            "GOOGLE_REDIRECT_URI"
            "PORT"
            "NODE_ENV"
          )
          
          missing_vars=()
          for var in "${required_vars[@]}"; do
            if ! grep -q "^${var}=" .env.example && ! grep -q "^# ${var}=" .env.example; then
              missing_vars+=("$var")
              echo "::error::Missing required variable: $var"
            else
              echo "✓ Found: $var"
            fi
          done
          
          if [ ${#missing_vars[@]} -ne 0 ]; then
            echo "::error::Missing ${#missing_vars[@]} required environment variable(s)"
            exit 1
          fi
          
          echo "All required environment variables present!"

      - name: Validate SQL schema syntax
        run: |
          echo "Starting PostgreSQL container for schema validation..."
          docker run -d --name postgres-test \
            -e POSTGRES_DB=testdb \
            -e POSTGRES_USER=test \
            -e POSTGRES_PASSWORD=test \
            postgres:15-alpine
          
          echo "Waiting for PostgreSQL to be ready..."
          sleep 10
          
          echo "Testing SQL schema..."
          if docker exec -i postgres-test psql -U test -d testdb < DataBase/Mentormatch.sql; then
            echo "✅ SQL schema is valid"
          else
            echo "::error::SQL schema validation failed"
            exit 1
          fi
          
          docker stop postgres-test
          docker rm postgres-test

      - name: Check for outdated dependencies
        working-directory: ./BackEnd
        run: |
          npm outdated || echo "Some dependencies are outdated (informational only)"
        continue-on-error: true

      - name: Validate API routes configuration
        run: |
          echo "Validating API routes..."
          if [ ! -f "BackEnd/src/routes.js" ]; then
            echo "::error::Missing routes.js file"
            exit 1
          fi
          
          if ! grep -q "module.exports" BackEnd/src/routes.js; then
            echo "::error::routes.js does not export properly"
            exit 1
          fi
          
          echo "✅ API routes configuration valid"

  # Summary Job - Runs after all jobs complete
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, docker-build, config-validation]
    if: always()
    
    steps:
      - name: Check all jobs status
        run: |
          echo "### CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Config Validation | ${{ needs.config-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.code-quality.result }}" == "success" ]] && \
             [[ "${{ needs.docker-build.result }}" == "success" ]] && \
             [[ "${{ needs.config-validation.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All checks passed!**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Some checks failed. Please review the logs above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

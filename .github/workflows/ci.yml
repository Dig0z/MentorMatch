name: MentorMatch CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'

jobs:
  # Job 1: Code Quality Checks
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run ESLint on backend
        run: npm run lint || echo "::warning::ESLint found issues but continuing..."
        continue-on-error: true

      - name: Check for security vulnerabilities
        run: npm audit --audit-level=moderate || echo "::warning::Security vulnerabilities found"
        continue-on-error: true

      - name: Validate required files exist
        run: |
          echo "Checking required files..."
          files=(
            "Dockerfile"
            ".dockerignore"
            "BackEnd/.env.example"
            "BackEnd/src/app.js"
            "BackEnd/src/bootstrap.js"
            "package.json"
            "package-lock.json"
            "DataBase/Mentormatch.sql"
            "FrontEnd/Pages/Home.html"
          )
          
          missing_files=()
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
              echo "::error::Missing required file: $file"
            else
              echo "✓ Found: $file"
            fi
          done
          
          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "::error::Missing ${#missing_files[@]} required file(s)"
            exit 1
          fi
          
          echo "All required files present!"

      - name: Check for console.log in production code
        run: |
          echo "Scanning for console.log statements..."
          if grep -r "console\.log" BackEnd/src --include="*.js" | grep -v "//.*console\.log"; then
            echo "::warning::Found console.log statements in production code"
          else
            echo "No problematic console.log statements found"
          fi
        continue-on-error: true

      - name: Validate package.json scripts
        run: |
          echo "Validating package.json scripts..."
          if ! grep -q '"start"' package.json; then
            echo "::error::Missing 'start' script in package.json"
            exit 1
          fi
          if ! grep -q '"test"' package.json; then
            echo "::warning::Missing 'test' script in package.json"
          fi
          echo "package.json scripts validated!"

  # Job 2: Docker Build Verification
  docker-build:
    name: Docker Build & Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: mentormatch:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Get Docker image size
        run: |
          SIZE=$(docker images mentormatch:ci-${{ github.sha }} --format "{{.Size}}")
          echo "Docker image size: $SIZE"
          echo "### Docker Build Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** mentormatch:ci-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Size:** $SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status:** ✅ Success" >> $GITHUB_STEP_SUMMARY

      - name: Run Trivy security scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: mentormatch:ci-${{ github.sha }}
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Test Docker container health
        run: |
          echo "Testing Docker container starts correctly..."
          echo "Note: Container will fail to fully start without database, but we verify the build is correct"
          
          # Try to start container (will fail due to no database, but that's expected)
          docker run -d --name mentormatch-test \
            -e DB_HOST=localhost \
            -e DB_PORT=5432 \
            -e DB_NAME=test \
            -e DB_USER=test \
            -e DB_PASSWORD=test \
            -e JWT_SECRET=test_secret_key_for_ci \
            -e SENDGRID_API_KEY=SG.test_key_for_ci_only \
            -e GOOGLE_CLIENT_ID=test_client_id \
            -e GOOGLE_CLIENT_SECRET=test_client_secret \
            -e GOOGLE_REDIRECT_URI=http://localhost:5000/callback \
            -e PORT=5000 \
            mentormatch:ci-${{ github.sha }} || true
          
          echo "Waiting for container to attempt startup..."
          sleep 5
          
          # Check if container was created (even if it exited)
          if docker ps -a | grep -q mentormatch-test; then
            echo "✅ Container was created successfully"
            echo "Checking logs for startup errors (database connection expected to fail in CI)..."
            docker logs mentormatch-test || true
          else
            echo "::error::Container was not created"
            exit 1
          fi
          
          # Verify the image contains expected files
          echo "Verifying image structure..."
          docker run --rm --entrypoint ls mentormatch:ci-${{ github.sha }} -la /app/BackEnd/src/app.js || exit 1
          docker run --rm --entrypoint ls mentormatch:ci-${{ github.sha }} -la /app/FrontEnd/Pages/Home.html || exit 1
          echo "✅ Image structure verified"
          
          # Cleanup
          docker rm -f mentormatch-test 2>/dev/null || true

  # Job 3: E2E Tests with Playwright
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: mentormatch_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Setup test database
        run: |
          echo "Setting up test database..."
          PGPASSWORD=test_password psql -h localhost -U test_user -d mentormatch_test < DataBase/Mentormatch.sql
        env:
          PGPASSWORD: test_password

      - name: Create test environment file
        run: |
          cat > BackEnd/.env << EOF
          DB_HOST=localhost
          DB_PORT=5432
          DB_NAME=mentormatch_test
          DB_USER=test_user
          DB_PASSWORD=test_password
          DB_SCHEMA=Mentormatch
          JWT_SECRET=test_jwt_secret_for_ci_testing_only
          SENDGRID_API_KEY=SG.test_key_for_ci_only
          GOOGLE_CLIENT_ID=test_google_client_id
          GOOGLE_CLIENT_SECRET=test_google_client_secret
          GOOGLE_REDIRECT_URI=http://localhost:3000/auth/google/callback
          PORT=3000
          NODE_ENV=test
          EOF

      - name: Start application server
        run: |
          echo "Starting application server in background..."
          npm run start:test &
          SERVER_PID=$!
          echo "Server started with PID: $SERVER_PID"
          
          echo "Waiting for server to become ready..."
          attempt=0
          timeout 60 bash -c 'until curl -sf http://localhost:3000/Pages/Home.html > /dev/null 2>&1; do 
            echo "Waiting for server... (attempt $((++attempt)))"
            sleep 3
          done' || {
            echo "::error::Server failed to start within 60 seconds"
            echo "Checking if server process is still running..."
            ps aux | grep node || echo "No node processes found"
            exit 1
          }
          
          echo "✅ Server is ready!"
        env:
          CI: true

      - name: Run Playwright E2E tests
        run: npm run test:e2e
        env:
          CI: true
          BASE_URL: http://localhost:3000

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots
          path: e2e/screenshots/
          retention-days: 7

  # Job 4: Configuration Validation
  config-validation:
    name: Configuration Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate .env.example completeness
        run: |
          echo "Validating .env.example..."
          required_vars=(
            "DB_HOST"
            "DB_PORT"
            "DB_NAME"
            "DB_USER"
            "DB_PASSWORD"
            "JWT_SECRET"
            "SENDGRID_API_KEY"
            "GOOGLE_CLIENT_ID"
            "GOOGLE_CLIENT_SECRET"
            "GOOGLE_REDIRECT_URI"
            "PORT"
          )
          
          missing_vars=()
          for var in "${required_vars[@]}"; do
            if ! grep -q "^${var}=" BackEnd/.env.example && ! grep -q "^# ${var}=" BackEnd/.env.example; then
              missing_vars+=("$var")
              echo "::error::Missing required variable: $var"
            else
              echo "✓ Found: $var"
            fi
          done
          
          if [ ${#missing_vars[@]} -ne 0 ]; then
            echo "::error::Missing ${#missing_vars[@]} required environment variable(s)"
            exit 1
          fi
          
          echo "All required environment variables present!"

      - name: Validate SQL schema syntax
        run: |
          echo "Starting PostgreSQL container for schema validation..."
          docker run -d --name postgres-test \
            -e POSTGRES_DB=testdb \
            -e POSTGRES_USER=test \
            -e POSTGRES_PASSWORD=test \
            postgres:15-alpine
          
          echo "Waiting for PostgreSQL to be ready..."
          sleep 10
          
          echo "Testing SQL schema..."
          if docker exec -i postgres-test psql -U test -d testdb < DataBase/Mentormatch.sql; then
            echo "✅ SQL schema is valid"
          else
            echo "::error::SQL schema validation failed"
            exit 1
          fi
          
          docker stop postgres-test
          docker rm postgres-test

      - name: Check for outdated dependencies
        run: npm outdated || echo "Some dependencies are outdated (informational only)"
        continue-on-error: true

      - name: Validate API routes configuration
        run: |
          echo "Validating API routes..."
          if [ ! -f "BackEnd/src/routes.js" ]; then
            echo "::error::Missing routes.js file"
            exit 1
          fi
          
          if ! grep -q "module.exports" BackEnd/src/routes.js; then
            echo "::error::routes.js does not export properly"
            exit 1
          fi
          
          echo "✅ API routes configuration valid"

  # Summary Job - Runs after all jobs complete
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, docker-build, e2e-tests, config-validation]
    if: always()
    
    steps:
      - name: Check all jobs status
        run: |
          echo "### CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Config Validation | ${{ needs.config-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.code-quality.result }}" == "success" ]] && \
             [[ "${{ needs.docker-build.result }}" == "success" ]] && \
             [[ "${{ needs.e2e-tests.result }}" == "success" ]] && \
             [[ "${{ needs.config-validation.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All checks passed!**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Some checks failed. Please review the logs above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

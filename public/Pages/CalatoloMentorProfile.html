<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentor - MentorMatch</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../CSS/Style.css">

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <style>
        .mentor-photo {
            width: 160px;
            height: 160px;
            border-radius: 12px;
            object-fit: cover;
            background: #ddd;
        }

        .info-box {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 14px rgba(0,0,0,0.08);
        }

        .review-box {
            background: #f7f7f7;
            border: 1px solid #e4e4e4;
            padding: 15px;
            border-radius: 10px;
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <div id="navbar"></div>

    <div class="container py-5">
        <div class="row g-4">

            <!-- FOTO -->
            <div class="col-md-3 text-center">
                <img id="mentorPhoto" src="../Img/default-user.png" class="mentor-photo mb-3">
                <h5 id="mentorName" class="fw-bold mt-2">—</h5>
                <p id="mentorRating" class="text-muted small">n/d</p>
            </div>

            <!-- INFO DEL MENTOR -->
            <div class="col-md-9">
                <div class="info-box">
                    <h4 class="fw-bold">Informazioni del Mentor</h4>
                    <p id="mentorBio" class="mt-3"></p>
                    <p id="mentorEmail"><strong>Email:</strong> —</p>
                    <p id="mentorLang"><strong>Lingue:</strong> —</p>
                    <p id="mentorSect"><strong>Settori:</strong> —</p>
                </div>
            </div>
        </div>

        <!-- CALENDARIO -->
        <div class="info-box mt-4">
            <h4 class="fw-bold mb-3">Calendario Disponibilità</h4>
            <div id="calendar"></div>
        </div>

        <!-- REVIEW + PRENOTAZIONE -->
        <div class="row mt-4 g-4">

            <!-- REVIEW -->
            <div class="col-md-6">
                <div class="info-box">
                    <h4 class="fw-bold mb-3">Lascia una Recensione</h4>

                    <label class="form-label">Valutazione (1–5)</label>
                    <select id="rating" class="form-select mb-3">
                        <option value="1">⭐ 1</option>
                        <option value="2">⭐ 2</option>
                        <option value="3">⭐ 3</option>
                        <option value="4">⭐ 4</option>
                        <option value="5" selected>⭐ 5</option>
                    </select>

                    <label class="form-label">Commento</label>
                    <textarea id="reviewText" class="form-control mb-3" rows="3" placeholder="Scrivi la tua opinione..."></textarea>

                    <button class="btn btn-primary w-100" id="submitReview">Invia Review</button>
                </div>
            </div>

            <!-- PRENOTA -->
            <div class="col-md-6">
                <div class="info-box text-center d-flex flex-column justify-content-between" style="height:100%;">
                    <div>
                        <h4 class="fw-bold mb-3">Prenota una Sessione</h4>
                        <p class="text-muted">Seleziona una data nel calendario e conferma la prenotazione.</p>
                        <div class="mt-3">
                            <p class="fw-semibold mb-1">Selezione corrente:</p>
                            <p id="selectedSlot" class="text-muted">Nessuna selezione</p>
                        </div>
                    </div>

                    <button class="btn btn-success btn-lg mt-3" id="bookBtn" disabled>
                        + Prenota
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- NAVBAR LOAD -->
    <script>
        fetch("../Components/navBar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("navbar").innerHTML = html;

                document.getElementById("logoutBtn")?.addEventListener("click", () => {
                    localStorage.clear();
                    window.location.href = "Log.html";
                });

                // Dashboard link by role
                const role = localStorage.getItem('role');
                const dash = document.getElementById('dashboardLink');
                if (dash) {
                    dash.href = role === 'mentor' ? 'MentorDashBoard.html' : 'MenteeDashBoard.html';
                }
            });
    </script>

    <!-- GLOBAL STATE FOR BOOKING SELECTION -->
    <script>
        var selected = null; // { date, start, end }
    </script>

    <!-- CALENDAR SCRIPT -->
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const API_BASE = 'http://localhost:3000';
            const params = new URLSearchParams(window.location.search);
            const email = params.get('email');
            if (!email) {
                window.location.href = 'CatalogoMentors.html';
                return;
            }

            const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
                initialView: "dayGridMonth",
                height: 600,
                headerToolbar: {
                    left: "prev,next today",
                    center: "title",
                    right: "dayGridMonth,timeGridWeek,timeGridDay"
                },
                eventClick(info) {
                    if (info.event.title !== 'Disponibile') return;
                    const date = info.event.startStr.slice(0, 10); // YYYY-MM-DD
                    const start = info.event.startStr.slice(11, 16); // HH:MM
                    const end = info.event.endStr.slice(11, 16);     // HH:MM
                    selected = { date, start, end };
                    document.getElementById('selectedSlot').textContent = `${date} • ${start} - ${end}`;
                    document.getElementById('bookBtn').disabled = false;
                }
            });
            calendar.render();

            try {
                const res = await fetch(`${API_BASE}/api/user/get_mentors?email=${encodeURIComponent(email)}`);
                const payload = await res.json();
                const rows = payload?.data || [];
                if (rows.length === 0) return;

                // aggregate mentor details
                const agg = {
                    name: rows[0].name || '',
                    surname: rows[0].surname || '',
                    bio: rows[0].bio || '',
                    photo: rows[0].photo_url || '',
                    rating: rows[0].avg_rating || null,
                    languages: new Set(),
                    sectors: new Set()
                };
                for (const r of rows) {
                    if (r.language_name) agg.languages.add(r.language_name);
                    if (r.sector_name) agg.sectors.add(r.sector_name);
                }

                document.getElementById('mentorName').textContent = `${agg.name} ${agg.surname}`.trim();
                document.getElementById('mentorBio').textContent = agg.bio || '';
                document.getElementById('mentorEmail').innerHTML = `<strong>Email:</strong> ${email}`;
                document.getElementById('mentorLang').innerHTML = `<strong>Lingue:</strong> ${Array.from(agg.languages).join(', ') || '—'}`;
                document.getElementById('mentorSect').innerHTML = `<strong>Settori:</strong> ${Array.from(agg.sectors).join(', ') || '—'}`;
                document.getElementById('mentorRating').textContent = agg.rating ? `⭐ ${agg.rating}` : 'n/d';
                const img = document.getElementById('mentorPhoto');
                if (img && agg.photo) {
                    img.src = agg.photo;
                    img.onerror = () => { img.src = '../Img/default-user.png'; };
                }

                // Load availability blocks by mentor email (mapped to next dates on backend)
                try {
                    const token = localStorage.getItem('token');
                    const ares = await fetch(`${API_BASE}/api/mentor_availability/get_availabilities_by_email?email=${encodeURIComponent(email)}`, {
                        headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                    });
                    const adata = await ares.json();
                    const avs = adata?.data || [];
                    avs.forEach(av => {
                        const date = typeof av.weekday === 'string' ? av.weekday.slice(0,10) : new Date(av.weekday).toISOString().slice(0,10);
                        const s = String(av.start_time).slice(0,5);
                        const e = String(av.end_time).slice(0,5);
                        calendar.addEvent({
                            title: 'Disponibile',
                            start: `${date}T${s}`,
                            end: `${date}T${e}`,
                            color: '#5cb85c'
                        });
                    });
                } catch (e) {
                    console.error('Load mentor availabilities failed', e);
                }
            } catch (e) {
                console.error('Load mentor profile failed', e);
            }
        });
    </script>

    <!-- REVIEW SCRIPT -->
    <script>
        document.getElementById("submitReview").addEventListener("click", () => {
            const rating = document.getElementById("rating").value;
            const text = document.getElementById("reviewText").value;

            alert("Review inviata!\n⭐ = " + rating + "\nCommento: " + text);
        });
    </script>

    <!-- PRENOTA -->
    <script>
        document.getElementById("bookBtn").addEventListener("click", async () => {
            const API_BASE = 'http://localhost:3000';
            const token = localStorage.getItem('token');
            const params = new URLSearchParams(window.location.search);
            const mentorEmail = params.get('email');
            if (!token) {
                alert('Devi fare il login');
                window.location.href = 'Log.html';
                return;
            }
            if (!mentorEmail || !selected) {
                alert('Seleziona una disponibilità nel calendario');
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/api/session/book_session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        mentor_email: mentorEmail,
                        date: selected.date,
                        start_time: selected.start,
                        end_time: selected.end
                    })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    const msg = data?.message || 'Errore durante la prenotazione';
                    alert(msg);
                    return;
                }
                document.getElementById('bookBtn').disabled = true;
                alert('Prenotazione registrata!');
                window.location.href = 'MenteeDashBoard.html?booked=1';
            } catch (e) {
                console.error(e);
                alert('Impossibile prenotare la sessione');
            }
        });
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Mentor - MentorMatch</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Main CSS -->
    <link rel="stylesheet" href="../CSS/Style.css">

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <style>
        .box-card {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.08);
        }

        .notif-box,
        .review-box {
            border-radius: 10px;
            padding: 15px;
            background: #f7f7f7;
            border: 1px solid #e4e4e4;
        }

        #calendar-small, #calendar-big {
            background: white;
            border-radius: 15px;
            padding: 10px;
        }

        /* ======================= FULLCALENDAR RESPONSIVE FIX ======================= */

        @media (max-width: 576px) {

            /* reduce padding */
            #calendar-small,
            #calendar-big {
                padding: 5px !important;
            }

            /* header toolbar vertical */
            .fc-toolbar.fc-header-toolbar {
                flex-direction: column !important;
                gap: 6px;
                text-align: center;
            }

            .fc-toolbar-chunk {
                display: flex;
                justify-content: center;
            }

            /* texto más compacto */
            .fc {
                font-size: 0.75rem !important;
            }

            .fc-daygrid-day {
                padding: 2px !important;
            }

            .fc-scroller {
                overflow: hidden !important;
            }
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <div id="navbar"></div>

    <div class="container py-5">

        <h2 class="fw-bold mb-4">Dashboard Mentor</h2>

        <div class="row g-4">

            <!-- PRENOTAZIONI -->
            <div class="col-lg-6">
                <div class="box-card">
                    <h4 class="fw-bold mb-3">Prenotazioni</h4>
                    <div id="calendar-small"></div>
                </div>
            </div>

            <!-- AGENDA PERSONALE -->
            <div class="col-lg-6">
                <div class="box-card">
                    <h4 class="fw-bold mb-3">Agenda Personale</h4>
                    <div id="calendar-big"></div>
                </div>
            </div>

            <!-- NOTIFICHE -->
            <div class="col-lg-6">
                <div class="box-card">
                    <h4 class="fw-bold mb-3">Notifiche</h4>
                    <div id="notificationsContainer"></div>

                </div>
            </div>

            <!-- RECENSIONI -->
            <div class="col-lg-6">
                <div class="box-card">
                    <h4 class="fw-bold mb-3">Recensioni</h4>
                    <div id="reviewsContainer"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODALE: Aggiungi Disponibilità -->
    <div class="modal fade" id="availabilityModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Aggiungi disponibilità</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <strong>Data:</strong> <span id="availabilityDate">—</span>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="availPaid">
                        <label class="form-check-label" for="availPaid">Slot a pagamento (solo estetico)</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="availType" id="availFullDay" checked>
                        <label class="form-check-label" for="availFullDay">Tutta la giornata (09:00–18:00)</label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="availType" id="availRange">
                        <label class="form-check-label" for="availRange">Intervallo orario</label>
                    </div>
                    <div class="row g-2">
                        <div class="col">
                            <label class="form-label">Dalle</label>
                            <input id="availStart" class="form-control" type="time" value="09:00" disabled>
                        </div>
                        <div class="col">
                            <label class="form-label">Alle</label>
                            <input id="availEnd" class="form-control" type="time" value="18:00" disabled>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" id="saveAvailabilityBtn" class="btn btn-primary">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALE: Rimuovi Disponibilità -->
    <div class="modal fade" id="deleteAvailabilityModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rimuovi disponibilità</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2"><strong>Data:</strong> <span id="delAvailabilityDate">—</span></p>
                    <p class="mb-3"><strong>Orario:</strong> <span id="delAvailabilityTime">—</span></p>
                    <p>Sei sicuro di voler rimuovere questa disponibilità?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" id="confirmDeleteAvailabilityBtn" class="btn btn-danger">Rimuovi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NAVBAR LOADER -->
    <script>
        fetch("../Components/navBar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("navbar").innerHTML = html;

                document.getElementById("logoutBtn")?.addEventListener("click", () => {
                    localStorage.clear();
                    window.location.href = "Log.html";
                });

                // Dashboard link by role
                const role = localStorage.getItem('role');
                const dash = document.getElementById('dashboardLink');
                if (dash) {
                    dash.href = role === 'mentor' ? 'MentorDashBoard.html' : 'MenteeDashBoard.html';
                }
            });
    </script>

    <!-- FULLCALENDAR SCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const isMobile = window.innerWidth < 576;

            // Visual-only helper: add days and format as local 'YYYY-MM-DDTHH:mm:ss'
            function pad2(n) { return String(n).padStart(2, '0'); }
            function formatLocal(d) {
                const y = d.getFullYear();
                const m = pad2(d.getMonth()+1);
                const day = pad2(d.getDate());
                const hh = pad2(d.getHours());
                const mm = pad2(d.getMinutes());
                const ss = pad2(d.getSeconds());
                return `${y}-${m}-${day}T${hh}:${mm}:${ss}`;
            }
            function addDaysFormatLocal(dt, days) {
                const s = String(dt);
                const src = s.includes(' ') ? s.replace(' ', 'T') : s;
                const d = new Date(src);
                d.setDate(d.getDate() + days);
                return formatLocal(d);
            }
            function minusDaysFormatLocal(dt, days) {
                const s = String(dt);
                const src = s.includes(' ') ? s.replace(' ', 'T') : s;
                const d = new Date(src);
                d.setDate(d.getDate() - days);
                return formatLocal(d);
            }
            function addDaysToYMD(ymd, days) {
                const d = new Date(`${ymd}T00:00:00`);
                d.setDate(d.getDate() + days);
                return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
            }

            /* ========================= SMALL CALENDAR ========================= */

            const smallCal = new FullCalendar.Calendar(
                document.getElementById('calendar-small'),
                {
                    timeZone: 'local',
                    initialView: isMobile ? 'dayGridWeek' : 'dayGridMonth',
                    height: isMobile ? 400 : 550,

                    headerToolbar: isMobile
                    ? { left: 'prev,next', center: 'title', right: '' }
                    : { left: 'prev,next today', center: 'title', right: 'dayGridMonth,dayGridWeek' },

                    events: async function(fetchInfo, successCallback, failureCallback) {
                        try {
                            const token = localStorage.getItem('token');
                            if (!token) { successCallback([]); return; }
                            const res = await fetch('http://localhost:3000/api/session/get_sessions', {
                                headers: { 'Authorization': `Bearer ${token}` },
                                cache: 'no-store'
                            });
                            if (!res.ok) { successCallback([]); return; }
                            const sessions = await res.json();
                            const arr = Array.isArray(sessions) ? sessions : (sessions?.data || []);
                            arr.forEach(s => {
                                try {
                                    console.log('API start_datetime:', s.start_datetime);
                                    console.log('Parsed local:', new Date(s.start_datetime).toString());
                                    console.log('Day:', new Date(s.start_datetime).getDate());
                                } catch (e) { console.log('Front parse error:', e?.message); }
                            });
                            const events = arr.map(s => ({
                                id: s.id,
                                title: s.status === 'confirmed' ? 'Sessione confermata' : 'Sessione prenotata',
                                start: addDaysFormatLocal(minusDaysFormatLocal(s.start_datetime, 1), 1),
                                end: addDaysFormatLocal(minusDaysFormatLocal(s.end_datetime, 1), 1),
                                color: s.status === 'confirmed' ? '#4a90e2' : '#16a085'
                            }));
                            successCallback(events);
                        } catch (err) {
                            console.error('Errore nel caricamento delle sessioni', err);
                            failureCallback(err);
                        }
                    }
                }
            );

            /* ========================= BIG CALENDAR ========================= */

            const bigCal = new FullCalendar.Calendar(
                document.getElementById('calendar-big'),
                {
                    timeZone: 'local',
                    initialView: isMobile ? 'timeGridDay' : 'timeGridWeek',
                    height: isMobile ? 400 : 550,
                    nowIndicator: true,

                    headerToolbar: isMobile
                    ? { left: 'prev,next', center: 'title', right: '' }
                    : { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },

                    eventSources: [
                        // Sessions source
                        {
                            events: async function(fetchInfo, successCallback, failureCallback) {
                                try {
                                    const token = localStorage.getItem('token');
                                    if (!token) { successCallback([]); return; }
                                    const res = await fetch('http://localhost:3000/api/session/get_sessions', {
                                        headers: { 'Authorization': `Bearer ${token}` },
                                        cache: 'no-store'
                                    });
                                    if (res.status === 401) { localStorage.clear(); window.location.href = 'Log.html'; return; }
                                    if (!res.ok) { successCallback([]); return; }
                                    const sessions = await res.json();
                                    const arr = Array.isArray(sessions) ? sessions : (sessions?.data || [])
                                    arr.forEach(s => {
                                        try {
                                            console.log('API start_datetime:', s.start_datetime);
                                            console.log('Parsed local:', new Date(s.start_datetime).toString());
                                            console.log('Day:', new Date(s.start_datetime).getDate());
                                        } catch (e) { console.log('Front parse error:', e?.message); }
                                    });
                                    const events = arr.map(s => ({
                                        id: s.id,
                                        title: s.status === 'confirmed' ? 'Sessione confermata' : 'Sessione prenotata',
                                        start: addDaysFormatLocal(minusDaysFormatLocal(s.start_datetime, 1), 1),
                                        end: addDaysFormatLocal(minusDaysFormatLocal(s.end_datetime, 1), 1),
                                        color: s.status === 'confirmed' ? '#007bff' : '#4a90e2'
                                    }));
                                    successCallback(events);
                                } catch (err) {
                                    console.error('Errore nel caricamento delle sessioni', err);
                                    failureCallback(err);
                                }
                            }
                        },
                        // Availabilities source
                        {
                            events: async function(fetchInfo, successCallback, failureCallback) {
                                try {
                                    const token = localStorage.getItem('token');
                                    if (!token) { successCallback([]); return; }
                                    const res = await fetch('http://localhost:3000/api/mentor_availability/get_availabilities', {
                                        headers: { 'Authorization': `Bearer ${token}` },
                                        cache: 'no-store'
                                    });
                                    if (res.status === 401) { localStorage.clear(); window.location.href = 'Log.html'; return; }
                                    if (!res.ok) { successCallback([]); return; }
                                    const data = await res.json();
                                    const rows = data?.data || [];
                                    const events = rows.map(r => {
                                        const dateStr = (typeof r.weekday === 'string')
                                            ? r.weekday.slice(0, 10)
                                            : (() => { const d = new Date(r.weekday); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; })();
                                        const s = String(r.start_time).slice(0,5);
                                        const e = String(r.end_time).slice(0,5);
                                        const dPlus = addDaysToYMD(dateStr, 1);
                                        const paid = !!(r.is_paid || r.paid);
                                        return {
                                            title: paid ? 'Disponibile • A pagamento' : 'Disponibile',
                                            start: `${dPlus}T${s}`,
                                            end: `${dPlus}T${e}`,
                                            color: paid ? '#f9e79f' : '#d1ecf1',
                                            extendedProps: { availabilityId: r.id, paid }
                                        };
                                    });
                                    successCallback(events);
                                } catch (err) {
                                    console.error('Errore nel caricamento delle disponibilità', err);
                                    failureCallback(err);
                                }
                            }
                        }
                    ],
                    dateClick(info) {
                        const role = localStorage.getItem('role');
                        if (role !== 'mentor') return;
                        const d = info.date; // Date in local time
                        const dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; // YYYY-MM-DD
                        document.getElementById('availabilityDate').textContent = dateStr;
                        const modal = new bootstrap.Modal(document.getElementById('availabilityModal'));
                        modal.show();

                        const start = document.getElementById('availStart');
                        const end = document.getElementById('availEnd');
                        const full = document.getElementById('availFullDay');
                        const range = document.getElementById('availRange');
                        const token = localStorage.getItem('token');

                        function updateInputs() {
                            const useRange = range.checked;
                            start.disabled = !useRange;
                            end.disabled = !useRange;
                        }
                        full.addEventListener('change', updateInputs);
                        range.addEventListener('change', updateInputs);
                        updateInputs();

                        document.getElementById('saveAvailabilityBtn').onclick = async () => {
                            try {
                                const isPaid = document.getElementById('availPaid').checked;
                                if (full.checked) {
                                    // One full-day block: 09:00–18:00
                                    const s = '09:00';
                                    const e = '18:00';
                                    const res = await fetch('http://localhost:3000/api/mentor_availability/add_availability', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify({ date: dateStr, start_time: s, end_time: e, is_paid: !!isPaid })
                                    });
                                    if (res.status === 401) { localStorage.clear(); window.location.href = 'Log.html'; return; }
                                    const data = await res.json().catch(() => ({}));
                                    if (!res.ok) {
                                        const msg = data?.message || 'Errore nel salvataggio';
                                        alert(msg);
                                        return;
                                    }
                                    const title = isPaid ? 'Disponibile • A pagamento' : 'Disponibile';
                                    const color = isPaid ? '#f9e79f' : '#d1ecf1';
                                    bigCal.addEvent({ title, start: `${dateStr}T${s}`, end: `${dateStr}T${e}`, color, extendedProps: { availabilityId: data?.data?.id || null, paid: !!isPaid } });
                                    modal.hide();
                                } else {
                                    const s = start.value || '09:00';
                                    const e = end.value || '18:00';
                                    const res = await fetch('http://localhost:3000/api/mentor_availability/add_availability', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify({ date: dateStr, start_time: s, end_time: e, is_paid: !!isPaid })
                                    });
                                    if (res.status === 401) { localStorage.clear(); window.location.href = 'Log.html'; return; }
                                    const data = await res.json().catch(() => ({}));
                                    if (!res.ok) {
                                        const msg = data?.message || 'Errore nel salvataggio';
                                        alert(msg);
                                        return;
                                    }
                                    const title = isPaid ? 'Disponibile • A pagamento' : 'Disponibile';
                                    const color = isPaid ? '#f9e79f' : '#d1ecf1';
                                    bigCal.addEvent({ title, start: `${dateStr}T${s}`, end: `${dateStr}T${e}`, color, extendedProps: { availabilityId: data?.data?.id || null, paid: !!isPaid } });
                                    modal.hide();
                                }
                            } catch (err) {
                                console.error(err);
                                alert('Impossibile salvare la disponibilità');
                            }
                        };
                    },
                    eventClick(info) {
                        const role = localStorage.getItem('role');
                        if (role !== 'mentor') return;
                        const availabilityId = info.event.extendedProps?.availabilityId;
                        if (!availabilityId) return; // ignora eventi non di disponibilità
                        const start = info.event.start;
                        const end = info.event.end;
                        const dateStr = start ? `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}-${String(start.getDate()).padStart(2,'0')}` : null;
                        const s = start ? start.toTimeString().slice(0,5) : '—';
                        const e = end ? end.toTimeString().slice(0,5) : '—';

                        document.getElementById('delAvailabilityDate').textContent = dateStr || '—';
                        document.getElementById('delAvailabilityTime').textContent = `${s} - ${e}`;

                        const modal = new bootstrap.Modal(document.getElementById('deleteAvailabilityModal'));
                        modal.show();

                        const token = localStorage.getItem('token');
                        const btn = document.getElementById('confirmDeleteAvailabilityBtn');
                        btn.onclick = () => {
                            fetch(`http://localhost:3000/api/mentor_availability/remove_availability/${availabilityId}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${token}` }
                            })
                            .then(res => {
                                if (res.status === 401) { localStorage.clear(); window.location.href = 'Log.html'; return Promise.reject('unauthorized'); }
                                return res.json().catch(() => ({}))
                            })
                            .then(j => {
                                if (j?.success) {
                                    info.event.remove();
                                    modal.hide();
                                } else {
                                    alert(j?.message || 'Impossibile rimuovere la disponibilità');
                                }
                            })
                            .catch(err => {
                                if (err !== 'unauthorized') {
                                    console.error(err);
                                    alert('Errore durante la rimozione');
                                }
                            });
                        };
                    }
                }
            );

            smallCal.render();
            bigCal.render();

            // Auto-refresh events when tab regains focus and on a short interval
            function refetchAll() {
                try { smallCal.refetchEvents(); } catch {}
                try { bigCal.refetchEvents(); } catch {}
            }
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) refetchAll();
            });
            setInterval(refetchAll, 30000);

            // Availabilities are now loaded via eventSources and auto-refreshed
        });
    </script>

    <!-- NOTIFICHE SCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            const container = document.getElementById('notificationsContainer');
            if (!container) return;
            container.innerHTML = '';
            async function loadNotifications() {
                container.innerHTML = '';
                try {
                    if (!token) return;
                    const res = await fetch('http://localhost:3000/api/notification/fetch_notifications', {
                        headers: { 'Authorization': `Bearer ${token}` },
                        cache: 'no-store'
                    });
                    const json = await res.json().catch(() => ({}));
                    const list = json?.data?.notifications || [];
                    if (!Array.isArray(list) || list.length === 0) {
                        const empty = document.createElement('div');
                        empty.className = 'notif-box';
                        empty.innerHTML = '<p class="small text-muted mb-0">Nessuna notifica al momento.</p>';
                        container.appendChild(empty);
                        return;
                    }
                    list.forEach(n => {
                        const box = document.createElement('div');
                        box.className = 'notif-box mb-3';
                        const msg = n?.message || '';
                        box.innerHTML = `<p class=\"mb-0\">${msg}</p>`;
                        container.appendChild(box);
                    });
                } catch (err) {
                    console.error('Errore caricando notifiche', err);
                }
            }
            await loadNotifications();
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) loadNotifications();
            });
            setInterval(loadNotifications, 30000);
        });
    </script>

    <!-- RECENSIONI SCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            const reviewsEl = document.getElementById('reviewsContainer');
            if (!reviewsEl) return;
            reviewsEl.innerHTML = '';
            try {
                if (!token) return;
                // Get current mentor email
                const meRes = await fetch('http://localhost:3000/api/user/me', {
                    headers: { 'Authorization': `Bearer ${token}` },
                    cache: 'no-store'
                });
                if (meRes.status === 401) { localStorage.clear(); window.location.href = 'Log.html'; return; }
                const meJson = await meRes.json().catch(() => ({}));
                const email = meJson?.data?.email;
                if (!email) { reviewsEl.innerHTML = '<p class="small text-muted mb-0">Nessuna recensione al momento.</p>'; return; }

                const rres = await fetch(`http://localhost:3000/api/review/get_reviews?email=${encodeURIComponent(email)}&limit=20`, { cache: 'no-store' });
                const rjson = await rres.json().catch(() => ({}));
                const list = rjson?.data || [];
                if (!Array.isArray(list) || list.length === 0) {
                    reviewsEl.innerHTML = '<p class="small text-muted mb-0">Nessuna recensione al momento.</p>';
                    return;
                }
                list.forEach(rv => {
                    const box = document.createElement('div');
                    box.className = 'review-box mb-3';
                    const mName = rv.mentee_name ?? rv.menteeName ?? rv.name;
                    const mSurname = rv.mentee_surname ?? rv.menteeSurname ?? rv.surname;
                    const mail = rv.mentee_email ?? rv.email ?? '';
                    let name = [mName, mSurname].filter(Boolean).join(' ').trim();
                    if (!name || name.length < 2) {
                        const local = (mail && typeof mail === 'string') ? mail.split('@')[0] : '';
                        name = local || 'Studente';
                    }
                    const stars = '⭐'.repeat(Number(rv.rating) || 0);
                    const when = rv.created_at ? new Date(rv.created_at).toLocaleDateString() : '';
                    box.innerHTML = `
                        <strong>${stars || 'Review'}</strong>
                        <p class="mb-1 small text-muted">Studente: ${name} ${mail ? '('+mail+')' : ''} ${when ? '• ' + when : ''}</p>
                        <p class="small">${rv.comment ? String(rv.comment) : ''}</p>
                    `;
                    reviewsEl.appendChild(box);
                });
            } catch (err) {
                console.error('Errore caricando recensioni', err);
                reviewsEl.innerHTML = '<p class="small text-muted mb-0">Impossibile caricare le recensioni.</p>';
            }
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

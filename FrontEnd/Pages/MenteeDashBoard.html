<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentee Dashboard - MentorMatch</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Main CSS -->
    <link rel="stylesheet" href="../CSS/Style.css">

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <style>
        /* Caja del calendario */
        #calendar {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.08);
        }

        /* Caja de notificaciones */
        .notif-box {
            border-radius: 10px;
            padding: 15px;
            background: #f7f7f7;
            border: 1px solid #e4e4e4;
        }

        /* ===== RESPONSIVE FIX PARA FULLCALENDAR ===== */
        @media (max-width: 576px) {

            #calendar {
                padding: 10px !important;
            }

            /* Toolbar vertical */
            .fc-toolbar.fc-header-toolbar {
                flex-direction: column !important;
                gap: 6px;
                text-align: center;
            }

            .fc-toolbar-chunk {
                display: flex;
                justify-content: center;
            }

            /* Reduce tamaño del calendario */
            .fc {
                font-size: 0.75rem;
            }

            .fc-daygrid-day {
                padding: 2px !important;
            }

            .fc-scroller {
                overflow: hidden !important;
            }
        }
    </style>
</head>

<body>

    <!-- NAVBAR DINÁMICA -->
    <div id="navbar"></div>

    <div class="container py-5">

        <h2 class="fw-bold mb-4">Dashboard Mentee</h2>

        <div id="bookedAlert" class="alert alert-success d-none" role="alert">
            Prenotazione registrata!
        </div>

        <!-- CALENDARIO -->
        <div class="card p-4 shadow-sm mb-5">
            <h4 class="fw-bold mb-3">Il Tuo Calendario</h4>
            <div id="calendar"></div>
        </div>

        <!-- NOTIFICHE -->
        <div class="card p-4 shadow-sm">
            <h4 class="fw-bold mb-4">Notifiche</h4>

            <div class="notif-box mb-3">
                <p class="fw-semibold mb-1">Prossimo appuntamento tra 24 ore.</p>
                <p class="small text-muted">Ricorda di preparare le domande per il tuo mentor.</p>
            </div>

            <div class="notif-box mb-3">
                <p class="fw-semibold mb-1">Nuovo feedback disponibile.</p>
                <p class="small text-muted">Controlla il feedback della tua ultima sessione.</p>
            </div>

            <div class="notif-box">
                <p class="fw-semibold mb-1">Aggiorna la tua biografia.</p>
                <p class="small text-muted">Il tuo profilo ha ricevuto 5 visualizzazioni questa settimana.</p>
            </div>

        </div>
    </div>

    <!-- NAVBAR LOADER -->
    <script>
        fetch("../Components/navBar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("navbar").innerHTML = html;

                // Logout funcional
                document.getElementById("logoutBtn")?.addEventListener("click", () => {
                    localStorage.clear();
                    window.location.href = "Log.html";
                });

                // Dashboard link by role
                const role = localStorage.getItem('role');
                const dash = document.getElementById('dashboardLink');
                if (dash) {
                    dash.href = role === 'mentor' ? 'MentorDashBoard.html' : 'MenteeDashBoard.html';
                }
            });
    </script>

    <!-- FULLCALENDAR SCRIPT -->
    <script>
        const API_BASE = 'http://localhost:3000';
        const token = localStorage.getItem('token');
        // Show success alert if redirected after booking
        (function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('booked') === '1') {
                const el = document.getElementById('bookedAlert');
                if (el) el.classList.remove('d-none');
                // Clean query param after showing
                const url = new URL(window.location.href);
                url.searchParams.delete('booked');
                window.history.replaceState({}, '', url.pathname);
            }
        })();
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const isMobile = window.innerWidth < 576;
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: isMobile ? 'dayGridWeek' : 'dayGridMonth',
                height: isMobile ? 400 : 650,
                headerToolbar: isMobile
                    ? { left: 'prev,next', center: 'title', right: '' }
                    : { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
                eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false },
                events: async function(fetchInfo, successCallback, failureCallback) {
                    try {
                        if (!token) { successCallback([]); return; }
                        const res = await fetch(`${API_BASE}/api/session/get_sessions`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (!res.ok) { successCallback([]); return; }
                        const sessions = await res.json();
                        const arr = Array.isArray(sessions) ? sessions : (sessions?.data || []);
                        const events = arr.map(s => ({
                            id: s.id,
                            title: s.status === 'confirmed' ? 'Sessione confermata' : 'Sessione prenotata',
                            start: s.start_datetime,
                            end: s.end_datetime,
                        }));
                        successCallback(events);
                    } catch (err) {
                        console.error('Errore nel caricamento delle sessioni', err);
                        failureCallback(err);
                    }
                }
            });
            calendar.render();
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilo - MentorMatch</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Main CSS -->
    <link rel="stylesheet" href="../CSS/Style.css">

    <style>
        /* Foto grande */
        .profile-photo {
            width: 180px;
            height: 180px;
            object-fit: cover;
            border-radius: 15px;
            background-color: #e5e5e5;
            border: 2px solid #ddd;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .profile-box {
            background: #ffffff;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 0 18px rgba(0,0,0,0.07);
        }

        .sector-box {
            background: #f7f7f7;
            border: 1px solid #e4e4e4;
            border-radius: 10px;
            padding: 12px 18px;
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <div id="navbar"></div>

    <div class="container py-5">
        <h2 class="fw-bold mb-4">Profilo</h2>

        <div class="row g-5">

            <!-- FOTO -->
            <div class="col-lg-3 col-md-4 text-center">
                <img id="profileImage" src="../Img/default-user.png" class="profile-photo mb-3">

                <input type="file" id="photoInput" class="form-control mb-2">
                <button class="btn btn-primary w-100" onclick="uploadPhoto()">Aggiorna Foto</button>
            </div>

            <!-- DATI PERSONALI -->
            <div class="col-lg-9 col-md-8">
                <div class="profile-box">

                    <h4 class="fw-bold mb-3">Dati Personali</h4>

                    <div class="row g-3 mb-3">

                        <!-- NOME (no editable) -->
                        <div class="col-md-6">
                            <label class="form-label">Nome</label>
                            <div id="nameField" class="form-control bg-light">{{NOME}}</div>
                        </div>

                        <!-- COGNOME (no editable) -->
                        <div class="col-md-6">
                            <label class="form-label">Cognome</label>
                            <div id="surnameField" class="form-control bg-light">{{COGNOME}}</div>
                        </div>

                        <!-- EMAIL (no editable) -->
                        <div class="col-md-12">
                            <label class="form-label">Email</label>
                            <div id="emailField" class="form-control bg-light">{{EMAIL}}</div>
                        </div>

                        <!-- LINGUE (CHECKBOXES) - visibile per tutti -->
                        <div class="col-md-12" id="languagesSection">
                            <label class="form-label">Lingue parlate</label>
                            <div class="sector-box">
                                <div class="form-check">
                                    <input class="form-check-input lang-checkbox" type="checkbox" value="Italiano" id="lang1" disabled>
                                    <label class="form-check-label" for="lang1">Italiano</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input lang-checkbox" type="checkbox" value="Inglese" id="lang2" disabled>
                                    <label class="form-check-label" for="lang2">Inglese</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input lang-checkbox" type="checkbox" value="Spagnolo" id="lang3" disabled>
                                    <label class="form-check-label" for="lang3">Spagnolo</label>
                                </div>
                            </div>
                        </div>

                        <!-- SECTOR (CHECKBOXES) -->
                        <div class="col-md-12" id="sectorSection">
                            <label class="form-label">Settori di competenza</label>

                            <div class="sector-box">

                                <div class="form-check">
                                    <input class="form-check-input sector-checkbox" type="checkbox" value="Programmazione" id="sector1" disabled>
                                    <label class="form-check-label" for="sector1">Programmazione</label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input sector-checkbox" type="checkbox" value="Design" id="sector2" disabled>
                                    <label class="form-check-label" for="sector2">Design</label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input sector-checkbox" type="checkbox" value="Marketing" id="sector3" disabled>
                                    <label class="form-check-label" for="sector3">Marketing</label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input sector-checkbox" type="checkbox" value="Business" id="sector4" disabled>
                                    <label class="form-check-label" for="sector4">Business</label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input sector-checkbox" type="checkbox" value="Data Science" id="sector5" disabled>
                                    <label class="form-check-label" for="sector5">Data Science</label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input sector-checkbox" type="checkbox" value="AI / Machine Learning" id="sector6" disabled>
                                    <label class="form-check-label" for="sector6">AI / Machine Learning</label>
                                </div>

                            </div>
                        </div>

                        <!-- BIO -->
                        <div class="col-md-12">
                            <label class="form-label">Biografia</label>
                            <textarea id="bio" class="form-control" rows="4" placeholder="Scrivi una breve descrizione..." disabled></textarea>
                        </div>

                    </div>

                    <button id="editSaveBtn" class="btn btn-primary w-100">Modifica</button>

                </div>

                <!-- RECENSIONI Y CALENDARIO -->
                <div class="row g-4 mt-4">

                    <div class="col-lg-6">
                        <div class="profile-box">
                            <h5 class="fw-bold mb-2">Recensioni</h5>
                            <p class="small text-muted">Ultima recensione:</p>
                            <p class="mb-2">"Molto professionale e disponibile!"</p>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="profile-box">
                            <h5 class="fw-bold mb-2">Calendario</h5>
                            <p class="small text-muted">Prossima sessione:</p>
                            <p class="mb-2">Domani, ore 15:00</p>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <!-- NAVBAR LOADER -->
    <script>
        fetch("../Components/navBar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("navbar").innerHTML = html;

                document.getElementById("logoutBtn")?.addEventListener("click", () => {
                    localStorage.clear();
                    window.location.href = "Log.html";
                });

                // Dashboard link by role
                const role = localStorage.getItem('role');
                const dash = document.getElementById('dashboardLink');
                if (dash) {
                    dash.href = role === 'mentor' ? 'MentorDashBoard.html' : 'MenteeDashBoard.html';
                }
            });
    </script>

    <!-- SCRIPT PERFIL -->
    <script>
        // Muestra/oculta sectores segÃºn rol guardado en login
        document.addEventListener('DOMContentLoaded', () => {
            const role = localStorage.getItem('role');
            if (role !== 'mentor') {
                const section = document.getElementById('sectorSection');
                if (section) section.classList.add('d-none');
            }

            // Cargar datos del usuario autenticado
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'Log.html';
                return;
            }
            fetch('http://localhost:3000/api/user/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(r => r.json())
            .then(j => {
                const d = j?.data;
                if (!d) return;
                document.getElementById('nameField').textContent = d.name ?? '';
                document.getElementById('surnameField').textContent = d.surname ?? '';
                document.getElementById('emailField').textContent = d.email ?? '';
                // Si es mentor, precargar sectores
                if (role === 'mentor') {
                    loadSectors(token);
                }
                // Precarica lingue per tutti
                loadLanguages(token);
            })
            .catch(err => console.error('Load profile failed', err));
        });

        let initialSectors = new Set();
        let initialLanguages = new Set();

        async function loadSectors(token) {
            try {
                const res = await fetch('http://localhost:3000/api/mentor_sector/get_sectors', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const sectors = data?.data?.sectors || [];
                initialSectors = new Set(sectors.map(s => s.sector_name));
                document.querySelectorAll('.sector-checkbox').forEach(chk => {
                    chk.checked = initialSectors.has(chk.value);
                });
            } catch (e) {
                console.error('Load sectors failed', e);
            }
        }

        async function loadLanguages(token) {
            try {
                const res = await fetch('http://localhost:3000/api/user_language/get_languages', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const langs = data?.data?.languages || [];
                initialLanguages = new Set(langs.map(l => l.language_name));
                document.querySelectorAll('.lang-checkbox').forEach(chk => {
                    chk.checked = initialLanguages.has(chk.value);
                });
            } catch (e) {
                console.error('Load languages failed', e);
            }
        }

        function setSectorInputsDisabled(disabled) {
            document.querySelectorAll('.sector-checkbox').forEach(chk => {
                if (disabled) chk.setAttribute('disabled', '');
                else chk.removeAttribute('disabled');
            });
        }

        function setLangInputsDisabled(disabled) {
            document.querySelectorAll('.lang-checkbox').forEach(chk => {
                if (disabled) chk.setAttribute('disabled', '');
                else chk.removeAttribute('disabled');
            });
        }

        function getSelectedSectors() {
            const list = [];
            document.querySelectorAll('.sector-checkbox:checked').forEach(chk => list.push(chk.value));
            return new Set(list);
        }

        function getSelectedLanguages() {
            const list = [];
            document.querySelectorAll('.lang-checkbox:checked').forEach(chk => list.push(chk.value));
            return new Set(list);
        }

        function uploadPhoto() {
            alert("Sistema di caricamento foto da collegare al backend.");
        }

        // Toggle Modifica/Salva y persiste la bio
        document.getElementById('editSaveBtn').addEventListener('click', async () => {
            const btn = document.getElementById('editSaveBtn');
            const bioEl = document.getElementById('bio');
            const token = localStorage.getItem('token');
            const role = localStorage.getItem('role');
            if (!token) {
                window.location.href = 'Log.html';
                return;
            }

            if (btn.textContent.trim().toLowerCase() === 'modifica') {
                bioEl.removeAttribute('disabled');
                bioEl.focus();
                btn.textContent = 'Salva';
                if (role === 'mentor') setSectorInputsDisabled(false);
                setLangInputsDisabled(false);
                return;
            }

            // Salvar
            const new_bio = bioEl.value;
            try {
                const res = await fetch('http://localhost:3000/api/user/update_bio', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ bio: new_bio, new_bio: new_bio })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    const msg = data?.details?.map?.(e => e.message).join('\n') || data?.message || 'Errore nel salvataggio';
                    alert(msg);
                    return;
                }

                // Sync sectores si es mentor
                if (role === 'mentor') {
                    const current = getSelectedSectors();
                    const toAdd = [...current].filter(x => !initialSectors.has(x));
                    const toRemove = [...initialSectors].filter(x => !current.has(x));

                    const addCalls = toAdd.map(name => fetch('http://localhost:3000/api/mentor_sector/add_sector', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ sector_name: name })
                    }));
                    const removeCalls = toRemove.map(name => fetch('http://localhost:3000/api/mentor_sector/remove_sector', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ sector_name: name })
                    }));
                    const responses = await Promise.all([...addCalls, ...removeCalls]);
                    const allOk = responses.every(r => r.ok);
                    if (!allOk) {
                        alert('Alcuni settori non sono stati salvati');
                    } else {
                        initialSectors = current;
                    }
                }

                // Sync languages (para todos)
                {
                    const currentL = getSelectedLanguages();
                    const toAddL = [...currentL].filter(x => !initialLanguages.has(x));
                    const toRemoveL = [...initialLanguages].filter(x => !currentL.has(x));

                    const addCallsL = toAddL.map(name => fetch('http://localhost:3000/api/user_language/add_language', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ language_name: name })
                    }));
                    const removeCallsL = toRemoveL.map(name => fetch('http://localhost:3000/api/user_language/remove_language', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ language_name: name })
                    }));
                    const responsesL = await Promise.all([...addCallsL, ...removeCallsL]);
                    const allOkL = responsesL.every(r => r.ok);
                    if (!allOkL) {
                        alert('Alcune lingue non sono state salvate');
                    } else {
                        initialLanguages = currentL;
                    }
                }

                bioEl.setAttribute('disabled', '');
                setSectorInputsDisabled(true);
                setLangInputsDisabled(true);
                btn.textContent = 'Modifica';
                alert('Profilo salvato');
            } catch (e) {
                console.error(e);
                alert('Impossibile salvare la biografia');
            }
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

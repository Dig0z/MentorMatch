<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentor - MentorMatch</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../CSS/Style.css">

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <style>
        .mentor-photo {
            width: 160px;
            height: 160px;
            border-radius: 12px;
            object-fit: cover;
            background: #ddd;
        }

        .info-box {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 14px rgba(0,0,0,0.08);
        }

        .review-box {
            background: #f7f7f7;
            border: 1px solid #e4e4e4;
            padding: 15px;
            border-radius: 10px;
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <div id="navbar"></div>

    <div class="container py-5">
        <div class="row g-4">

            <!-- FOTO -->
            <div class="col-md-3 text-center">
                <img id="mentorPhoto" src="../Img/default-user.png" class="mentor-photo mb-3">
                <h5 id="mentorName" class="fw-bold mt-2">—</h5>
                <p id="mentorRating" class="text-muted small">n/d</p>
            </div>

            <!-- INFO DEL MENTOR -->
            <div class="col-md-9">
                <div class="info-box">
                    <h4 class="fw-bold">Informazioni del Mentor</h4>
                    <p id="mentorBio" class="mt-3"></p>
                    <p id="mentorEmail"><strong>Email:</strong> —</p>
                    <p id="mentorLang"><strong>Lingue:</strong> —</p>
                    <p id="mentorSect"><strong>Settori:</strong> —</p>
                </div>
            </div>
        </div>

        <!-- CALENDARIO -->
        <div class="info-box mt-4">
            <h4 class="fw-bold mb-3">Calendario Disponibilità</h4>
            <div id="calendar"></div>
        </div>

        <!-- REVIEW + PRENOTAZIONE -->
        <div class="row mt-4 g-4">

            <!-- REVIEW -->
            <div class="col-md-6">
                <div class="info-box">
                    <h4 class="fw-bold mb-3">Lascia una Recensione</h4>

                    <label class="form-label">Valutazione (1–5)</label>
                    <select id="rating" class="form-select mb-3">
                        <option value="1">⭐ 1</option>
                        <option value="2">⭐ 2</option>
                        <option value="3">⭐ 3</option>
                        <option value="4">⭐ 4</option>
                        <option value="5" selected>⭐ 5</option>
                    </select>

                    <label class="form-label">Commento</label>
                    <textarea id="reviewText" class="form-control mb-3" rows="3" placeholder="Scrivi la tua opinione..."></textarea>

                    <button class="btn btn-primary w-100" id="submitReview">Invia Review</button>
                </div>
            </div>

            <!-- PRENOTA -->
            <div class="col-md-6">
                <div class="info-box text-center d-flex flex-column justify-content-between" style="height:100%;">
                    <div>
                        <h4 class="fw-bold mb-3">Prenota una Sessione</h4>
                        <p class="text-muted">Seleziona una data nel calendario e conferma la prenotazione.</p>
                        <div class="mt-3">
                            <p class="fw-semibold mb-1">Selezione corrente:</p>
                            <p id="selectedSlot" class="text-muted">Nessuna selezione</p>
                            <p id="paidInfo" class="small text-warning d-none">Slot a pagamento: concorda il pagamento con il mentor durante la sessione.</p>
                        </div>
                    </div>

                    <button class="btn btn-success btn-lg mt-3" id="bookBtn" disabled>
                        + Prenota
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- NAVBAR LOAD -->
    <script>
        fetch("../Components/navBar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("navbar").innerHTML = html;

                document.getElementById("logoutBtn")?.addEventListener("click", () => {
                    localStorage.clear();
                    window.location.href = "Log.html";
                });

                // Dashboard link by role
                const role = localStorage.getItem('role');
                const dash = document.getElementById('dashboardLink');
                if (dash) {
                    dash.href = role === 'mentor' ? 'MentorDashBoard.html' : 'MenteeDashBoard.html';
                }
            });
    </script>

    <!-- GLOBAL STATE FOR BOOKING SELECTION -->
    <script>
        var selected = null; // { date, start, end }
    </script>

    <!-- CALENDAR SCRIPT -->
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const API_BASE = 'http://localhost:3000';
            const params = new URLSearchParams(window.location.search);
            const email = params.get('email');
            if (!email) {
                window.location.href = 'CatalogoMentors.html';
                return;
            }

            function dateToYMDLocal(date) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }
                function addDaysToYMD(ymd, days) {
                    const d = new Date(`${ymd}T00:00:00`);
                    d.setDate(d.getDate() + days);
                    return dateToYMDLocal(d);
                }

            const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
                initialView: "dayGridMonth",
                height: 600,
                timeZone: 'local',
                headerToolbar: {
                    left: "prev,next today",
                    center: "title",
                    right: "dayGridMonth,timeGridWeek,timeGridDay"
                },
                    eventClick(info) {
                        const title = info.event.title || '';
                        if (!title.toLowerCase().startsWith('disponibile')) return;
                        const startDateVisible = new Date(info.event.start);
                        // Compute real date for backend (visible is +1 day)
                        const realDate = new Date(startDateVisible);
                        realDate.setDate(realDate.getDate() - 1);
                        const date = dateToYMDLocal(realDate); // YYYY-MM-DD real for backend
                        const start = startDateVisible.toTimeString().slice(0, 5);
                        const end = info.event.end ? info.event.end.toTimeString().slice(0, 5) : start;
                        selected = { date, start, end };
                        const displayDate = dateToYMDLocal(startDateVisible);
                        document.getElementById('selectedSlot').textContent = `${displayDate} • ${start} - ${end}`;
                        const isPaid = /pagamento/i.test(title)
                            || (info.event.extendedProps && info.event.extendedProps.paid === true)
                            || (info.event.backgroundColor && String(info.event.backgroundColor).toLowerCase() === '#f9e79f')
                            || (info.event.color && String(info.event.color).toLowerCase() === '#f9e79f');
                        const paidInfoEl = document.getElementById('paidInfo');
                        if (paidInfoEl) {
                            paidInfoEl.classList.toggle('d-none', !isPaid);
                        }
                        document.getElementById('bookBtn').disabled = false;
                    }
            });
            calendar.render();

            try {
                const res = await fetch(`${API_BASE}/api/user/get_mentors?email=${encodeURIComponent(email)}`);
                const payload = await res.json();
                const rows = payload?.data || [];
                if (rows.length === 0) return;

                // aggregate mentor details
                const agg = {
                    name: rows[0].name || '',
                    surname: rows[0].surname || '',
                    bio: rows[0].bio || '',
                    photo: rows[0].photo_url || '',
                    rating: rows[0].avg_rating || null,
                    languages: new Set(),
                    sectors: new Set()
                };
                for (const r of rows) {
                    if (r.language_name) agg.languages.add(r.language_name);
                    if (r.sector_name) agg.sectors.add(r.sector_name);
                }

                document.getElementById('mentorName').textContent = `${agg.name} ${agg.surname}`.trim();
                document.getElementById('mentorBio').textContent = agg.bio || '';
                document.getElementById('mentorEmail').innerHTML = `<strong>Email:</strong> ${email}`;
                document.getElementById('mentorLang').innerHTML = `<strong>Lingue:</strong> ${Array.from(agg.languages).join(', ') || '—'}`;
                document.getElementById('mentorSect').innerHTML = `<strong>Settori:</strong> ${Array.from(agg.sectors).join(', ') || '—'}`;
                document.getElementById('mentorRating').textContent = agg.rating ? `⭐ ${agg.rating}` : 'n/d';
                const img = document.getElementById('mentorPhoto');
                if (img && agg.photo) {
                    img.src = agg.photo;
                    img.onerror = () => { img.src = '../Img/default-user.png'; };
                }

                // Load availability blocks by mentor email (mapped to next dates on backend)
                try {
                    const token = localStorage.getItem('token');
                    const ares = await fetch(`${API_BASE}/api/mentor_availability/get_availabilities_by_email?email=${encodeURIComponent(email)}`, {
                        headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                    });
                    if (ares.status === 401) { localStorage.clear(); window.location.href = 'Log.html'; return; }
                    const adata = await ares.json();
                    const avs = adata?.data || [];
                        avs.forEach(av => {
                            const date = (typeof av.weekday === 'string')
                                ? av.weekday.slice(0,10)
                                : (() => { const d = new Date(av.weekday); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; })();
                            const s = String(av.start_time).slice(0,5);
                            const e = String(av.end_time).slice(0,5);
                            const dPlus = addDaysToYMD(date, 1); // visual-only +1 day
                            const paid = !!(av.paid || av.is_paid);
                            calendar.addEvent({
                                title: paid ? 'Disponibile • A pagamento' : 'Disponibile',
                                start: `${dPlus}T${s}`,
                                end: `${dPlus}T${e}`,
                                color: paid ? '#f9e79f' : '#5cb85c',
                                extendedProps: { paid }
                            });
                        });
                } catch (e) {
                    console.error('Load mentor availabilities failed', e);
                }
            } catch (e) {
                console.error('Load mentor profile failed', e);
            }
        });
    </script>

    <!-- REVIEW SCRIPT -->
    <script>
        document.getElementById("submitReview").addEventListener("click", async () => {
            const API_BASE = 'http://localhost:3000';
            const token = localStorage.getItem('token');
            const rating = document.getElementById("rating").value;
            const text = document.getElementById("reviewText").value;
            const params = new URLSearchParams(window.location.search);
            const mentorEmail = params.get('email');

            if (!mentorEmail) { alert('Mentor non valido'); return; }
            if (!token) { alert('Devi fare il login'); window.location.href = 'Log.html'; return; }
            try {
                const res = await fetch(`${API_BASE}/api/review/add_review`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ mentor_email: mentorEmail, rating: Number(rating), comment: text })
                });
                const data = await res.json().catch(() => ({}));
                if (res.status === 401) { localStorage.clear(); window.location.href = 'Log.html'; return; }
                if (!res.ok || !data?.success) {
                    alert(data?.message || 'Impossibile inviare la review');
                    return;
                }
                document.getElementById("reviewText").value = '';
                alert('Review inviata! Grazie!');
            } catch (e) {
                console.error(e);
                alert('Errore durante l\'invio della review');
            }
        });
    </script>

    <!-- PRENOTA -->
    <script>
        document.getElementById("bookBtn").addEventListener("click", async () => {
            const API_BASE = 'http://localhost:3000';
            const token = localStorage.getItem('token');
            const params = new URLSearchParams(window.location.search);
            const mentorEmail = params.get('email');
            if (!token) {
                alert('Devi fare il login');
                window.location.href = 'Log.html';
                return;
            }
            if (!mentorEmail || !selected) {
                alert('Seleziona una disponibilità nel calendario');
                return;
            }
            try {
                // Al click prenota: somma +1 giorno alla data inviata
                const base = new Date(`${selected.date}T00:00:00`);
                base.setDate(base.getDate() + 1);
                const y = base.getFullYear();
                const m = String(base.getMonth() + 1).padStart(2, '0');
                const d = String(base.getDate()).padStart(2, '0');
                const dateToSend = `${y}-${m}-${d}`;
                const res = await fetch(`${API_BASE}/api/session/book_session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        mentor_email: mentorEmail,
                        date: dateToSend,
                        start_time: selected.start,
                        end_time: selected.end
                    })
                });
                if (res.status === 401) { localStorage.clear(); window.location.href = 'Log.html'; return; }
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    const msg = data?.message || 'Errore durante la prenotazione';
                    alert(msg);
                    return;
                }
                document.getElementById('bookBtn').disabled = true;
                alert('Prenotazione registrata!');
                window.location.href = 'MenteeDashBoard.html?booked=1';
            } catch (e) {
                console.error(e);
                alert('Impossibile prenotare la sessione');
            }
        });
    </script>

</body>
</html>
